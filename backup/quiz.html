<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互动测验页面</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Load the quiz data JavaScript file -->
    <script src="quiz_data.js"></script>
    <style>
        /* Global box-sizing for consistent layout */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Ensure html and body take full viewport height */
        html, body {
            height: 100%; /* Ensure html takes full height */
            margin: 0;
            padding: 0;
            overflow: hidden; /* Keep original overflow: hidden on body */
        }

        /* General body styling for black and green theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Dark background */
            color: #e0e0e0; /* Light text color */
            display: flex; /* Use flexbox for main layout */
            height: 100vh; /* Full viewport height */
        }

        /* Custom Scrollbar Styles for WebKit browsers (Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: 8px; /* Vertical scrollbar width */
            height: 8px; /* Horizontal scrollbar height */
        }

        ::-webkit-scrollbar-track {
            background: #2a2a2a; /* Scrollbar track background */
            border-radius: 10px; /* Rounded corners for the track */
        }

        ::-webkit-scrollbar-thumb {
            background: #555; /* Scrollbar thumb color */
            border-radius: 10px; /* Rounded corners for the thumb */
            border: 2px solid #2a2a2a; /* Border around the thumb, matching track background */
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #777; /* Scrollbar thumb color on hover */
        }

        /* Custom Scrollbar Styles for Firefox */
        html {
            scrollbar-width: thin; /* "auto" or "thin" */
            scrollbar-color: #555 #2a2a2a; /* thumb color track color */
        }


        /* Main container for the quiz layout */
        .quiz-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* Sidebar Toggle Button - Moved outside the sidebar again, fixed */
        /* This button will only be used to SHOW the sidebar when it's hidden */
        #showSidebarIconContainer {
            background-color: #4CAF50; /* Green button */
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px; /* Larger padding for prominent fixed button */
            cursor: pointer;
            font-size: 16px; /* Larger font size */
            position: fixed; /* Keep it fixed */
            left: 20px; /* Fixed position from left */
            top: 20px; /* Fixed position from top */
            z-index: 1002; /* Ensure it's above other content */
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            display: none; /* Initially hidden */
            align-items: center; /* Center icon vertically */
            justify-content: center; /* Center icon horizontally */
            width: 40px; /* Make it a square button */
            height: 40px;
        }

        #showSidebarIconContainer:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }
        
        #showSidebarIconContainer i {
            font-size: 20px; /* Adjust icon size within the button */
        }


        /* Left sidebar navigation */
        .sidebar {
            width: 320px; /* Increased default width for better text display */
            background-color: #2a2a2a; /* Slightly lighter dark for sidebar */
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease-in-out; /* Smooth transition for hide/show */
            flex-shrink: 0; /* Prevent shrinking */
            display: flex;
            flex-direction: column; /* Arrange header and content vertically */
            position: fixed; /* Fixed to prevent content jumping */
            top: 0;
            left: 0;
            height: 100%; /* Make sidebar take 100% height of its parent (html/body flex context) */
            border-right: 1px solid #333;
            z-index: 1000;
            transform: translateX(0); /* Default position */
        }

        .sidebar.hidden {
            transform: translateX(-100%); /* Move off-screen to the left */
        }

        .sidebar-header {
            display: flex;
            flex-direction: column; /* Stack h2 and select vertically */
            align-items: flex-start; /* Align content to start */
            margin-bottom: 15px; /* Space between header and list */
            flex-shrink: 0; /* Prevent header from shrinking */
            padding-left: 0; /* No left padding here, elements align to container edge */
            width: 100%; /* Take full width */
        }

        .sidebar-header h2 {
            margin: 0 0 10px 0; /* Adjust margin for h2 inside header */
            font-size: 20px; /* Adjust h2 font size if needed */
            color: #4CAF50;
            width: 100%; /* Take full width of its parent */
            display: flex; /* Make h2 a flex container for text and icon */
            justify-content: space-between; /* Push icon to the right */
            align-items: center; /* Vertically align icon with text */
        }

        /* Icon for hiding sidebar, now within h2 */
        #hideSidebarIcon {
            cursor: pointer;
            font-size: 20px;
            color: #e0e0e0;
            margin-left: 10px; /* Space from "测验导航" text */
            transition: color 0.2s ease;
        }

        #hideSidebarIcon:hover {
            color: #4CAF50;
        }

        /* Custom Dropdown Styles */
        .custom-dropdown {
            position: relative; /* For dropdown content positioning */
            width: 100%;
            margin-bottom: 15px;
        }

        .dropdown-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #3a3a3a;
            color: #e0e0e0;
            font-size: 16px;
            cursor: pointer;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .dropdown-toggle:hover {
            border-color: #4CAF50;
        }

        .dropdown-toggle.active {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.5);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%; /* Position below the toggle button */
            left: 0;
            width: 100%;
            background-color: #3a3a3a; /* Dark background for dropdown menu */
            border: 1px solid #555;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            list-style: none;
            padding: 0;
            margin: 5px 0 0 0; /* Space between toggle and menu */
            z-index: 1001; /* Ensure it's above other content */
            display: none; /* Hidden by default */
            max-height: 200px; /* Max height for scrollable menu */
            overflow-y: auto; /* Enable scrolling for menu items */
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-menu li {
            padding: 10px 15px;
            color: #e0e0e0;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            border-bottom: 1px solid #4a4a4a; /* Add bottom border for separation */
        }

        .dropdown-menu li:last-child {
            border-bottom: none; /* No border for the last item */
        }

        .dropdown-menu li:hover {
            background-color: #4CAF50; /* Green on hover */
            color: white;
        }

        .dropdown-arrow {
            transition: transform 0.2s ease;
        }

        .dropdown-toggle.active .dropdown-arrow {
            transform: rotate(180deg);
        }


        .sidebar-content {
            flex-grow: 1; /* Allows list to take remaining space */
            padding: 0; /* Reset padding, as sidebar itself has it */
            display: flex; /* For controlling the list within it */
            flex-direction: column;
            padding-right: 10px; /* Add some padding to prevent scrollbar overlapping text */
            min-height: 0; /* Critical for nested flex containers to allow scrolling children */
        }

        .quiz-nav {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1; /* Allow the list to expand */
            overflow-y: auto; /* Scroll for nav list itself */
        }

        .quiz-nav li {
            padding: 10px 15px;
            margin-bottom: 8px;
            background-color: #3a3a3a; /* Darker background for nav items */
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis for long titles */
        }

        .quiz-nav li:hover {
            background-color: #4CAF50; /* Green on hover */
            color: white;
        }

        .quiz-nav li.active {
            background-color: #4CAF50; /* Active quiz in green */
            color: white;
            font-weight: bold;
        }

        .quiz-nav li.completed {
            background-color: #28a745; /* Darker green for completed quizzes */
            color: #ffffff;
            opacity: 0.8;
        }

        /* Right main content area */
        .main-content {
            flex-grow: 1; /* Takes remaining space */
            display: flex; /* Use flexbox to center inner wrapper */
            flex-direction: column; /* Keep column to stack the inner wrapper vertically (if needed) or just for flex properties */
            padding: 20px; /* Padding for main content */
            position: relative;
            overflow-y: auto; /* Main scroll for this area if content overflows */
            margin-left: 340px; /* Adjusted margin for new sidebar width (320px + 20px buffer) */
            transition: margin-left 0.3s ease-in-out; /* Keep for smooth transition */
            align-items: center; /* Center content horizontally */
            justify-content: flex-start; /* Align content to the top */
        }

        /* When sidebar is hidden, adjust main content margin-left to allow centering */
        body.sidebar-hidden .main-content {
            margin-left: 20px; /* Reduced margin when sidebar is hidden, aligns with left side */
        }


        /* NEW INNER WRAPPER for horizontal layout and max-width/centering */
        .main-content-inner-wrapper {
            display: flex;
            flex-direction: row; /* Horizontal layout for question and answers */
            gap: 20px; /* Space between question panel and interaction panel */
            width: 100%; /* Take full width of parent up to max-width */
            max-width: 1800px; /* Overall max width for the quiz content area */
            align-items: flex-start; /* Align children to their top */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            height: 100%; /* Make it take full height available from main-content's content box */
        }

        /* Left Panel: Question Text */
        .quiz-content-panel {
            flex: 2.5; /* Adjusted proportion to be larger */
            min-width: 450px; /* Minimum width for the question text panel */
            background-color: #2a2a2a;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            display: flex; /* Use flex for direct children: h2, quiz-type, question-text-scroll-wrapper */
            flex-direction: column;
            max-height: calc(100% - 0px); /* 100% of parent's height (main-content-inner-wrapper) */
        }

        /* Right Panel: Controls and Options */
        .quiz-interaction-panel {
            flex: 3; /* Adjusted proportion to be larger */
            min-width: 400px; /* Increased minimum width for interaction panel */
            display: flex;
            flex-direction: column; /* Stack controls and options vertically */
            gap: 20px; /* Gap between controls and options */
            background-color: #2a2a2a;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            max-height: calc(100% - 0px); /* 100% of parent's height (main-content-inner-wrapper) */
        }

        /* Styles for content within the left question panel */
        #quiz-title { /* Renamed from #question-container h2 for direct targeting */
            font-size: 24px;
            color: #4CAF50; /* Green for question title */
            margin-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            flex-shrink: 0; /* Prevent shrinking when content scrolls */
        }

        #quiz-type {
            font-size: 16px;
            color: #a0a0a0;
            margin-bottom: 15px;
            flex-shrink: 0; /* Prevent shrinking when content scrolls */
        }
        
        /* New wrapper for the scrollable question text */
        #question-text-scroll-wrapper {
            flex-grow: 1; /* Allows content to take available space */
            overflow-y: auto; /* Scroll for question text content */
            padding-right: 10px; /* Add some padding to prevent text from touching scrollbar */
            display: flex; /* Ensure its child `p` behaves well within it */
            flex-direction: column;
            gap: 15px; /* Spacing for consistency if future elements are added here */
        }

        .question-content {
            font-size: 18px;
            line-height: 1.6;
            white-space: pre-wrap; /* Preserve line breaks from content */
            margin-bottom: 0; /* No margin-bottom here, gap from parent handles it */
            color: #e0e0e0;
            flex-grow: 1; /* Allows content to grow and take space within the scroll wrapper */
        }

        /* Highlighted question number within the main content */
        .question-content .question-num-in-text {
            color: #87CEEB; /* Light blue for highlighting */
            text-decoration: underline;
            font-weight: bold;
            cursor: pointer; /* Indicate it's clickable */
            background-color: rgba(69, 160, 73, 0.2); /* Subtle green background for emphasis */
            padding: 2px 4px;
            border-radius: 4px;
            display: inline-block; /* Ensure padding and background apply correctly */
        }

        .question-content .question-num-in-text:hover {
            color: #ADD8E6; /* Slightly lighter blue on hover */
        }


        /* Controls remain the same, just moved into quiz-interaction-panel */
        .controls {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping for smaller screens */
            gap: 15px;
            align-items: center;
            padding-top: 0; /* No top padding, parent panel handles it */
            border-top: none; /* No top border, parent panel handles it */
        }

        .control-button {
            background-color: #4CAF50; /* Green button */
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 25px;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box_shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            flex-shrink: 0; /* Prevent shrinking */
        }

        .control-button:hover:not(:disabled) {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
        }

        .control-button:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .timer-display, .score-display {
            font-size: 18px;
            color: #4CAF50; /* Green for timer/score */
            background-color: #3a3a3a;
            padding: 10px 20px;
            border-radius: 8px;
            min-width: 150px;
            text-align: center;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Options container now specifically handles overflow for its content */
        .options-container {
            flex-grow: 1; /* Takes remaining vertical space in quiz-interaction-panel */
            overflow-y: auto; /* Critical for scrolling options */
            min-height: 100px; /* Minimum height for options area */
            /* No specific background/padding/shadow here, inherited from parent quiz-interaction-panel */
            display: flex; /* Keep flex for inner question blocks */
            flex-direction: column;
            gap: 15px; /* Space between question blocks */
            padding: 0; /* No padding, parent panel handles it */
        }

        /* Styling for each individual sub-question block */
        .question-block {
            background-color: #3a3a3a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid transparent; /* Default border */
            transition: border-color 0.3s ease;
        }

        .question-sub-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #87CEEB; /* Light blue for question number */
        }

        .choices-wrapper {
            display: grid; /* Changed to grid for better column control */
            grid-template-columns: repeat(4, minmax(0, 1fr)); /* 4 equal width columns */
            gap: 10px; /* Space between choices */
            align-items: stretch; /* Make all choice items in a row the same height */
            box-sizing: border-box; /* Ensure padding and border are included in width calculation */
        }

        /* Styling for each individual choice (A, B, C, D) */
        .choice-item {
            background-color: #444; /* Slightly lighter than question-block */
            padding: 12px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            border: 1px solid #555;
            display: flex; /* For aligning A. B. C. D. */
            align-items: center;
            font-size: 16px;
            box-sizing: border-box; /* Include padding and border in the width */
            white-space: nowrap; /* Prevent text wrapping inside choice item */
            overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis for long text */
        }

        @media (max-width: 1100px) { /* Adjusted breakpoint for 3 items per row on slightly smaller screens */
            .choices-wrapper {
                grid-template-columns: repeat(3, minmax(0, 1fr)); /* 3 equal width columns */
            }
        }

        @media (max-width: 900px) { /* Adjusted breakpoint for 2 items per row */
            .choices-wrapper {
                grid-template-columns: repeat(2, minmax(0, 1fr)); /* 2 equal width columns */
            }
        }

        @media (max-width: 700px) { /* Adjusted breakpoint for 1 item per row */
            .choices-wrapper {
                grid-template-columns: repeat(1, minmax(0, 1fr)); /* 1 equal width column */
            }
        }


        .choice-item:hover:not(.disabled):not(.selected-choice):not(.correct-choice):not(.incorrect-choice) {
            background-color: #555;
            border-color: #4CAF50;
        }

        /* Classes for selected, correct, incorrect choices */
        .choice-item.selected-choice {
            background-color: #4CAF50; /* Green for selected */
            border-color: #32CD32;
            color: white;
        }
        .choice-item.correct-choice {
            background-color: #28a745; /* Darker green for correct */
            border-color: #28a745;
            color: white;
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.5);
        }
        .choice-item.incorrect-choice {
            background-color: #dc3545; /* Red for incorrect */
            border-color: #dc3545;
            color: white;
            box-shadow: 0 0 8px rgba(220, 53, 69, 0.5);
        }
        .choice-item.disabled {
            cursor: not-allowed;
            opacity: 0.7;
            pointer-events: none; /* Prevent clicks when disabled */
        }

        /* Styling for individual question explanations */
        .question-explanation {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #555;
            font-size: 15px;
            line-height: 1.5;
            color: #c0c0c0;
        }
        .question-explanation .your-answer {
            font-weight: bold;
            color: #87CEEB; /* Light blue for user's answer */
        }
        .question-explanation .correct-answer {
            font-weight: bold;
            color: #28a745; /* Dark green for correct answer */
        }
        .explanation-icon {
            margin-right: 8px; /* Space between icon and text */
            font-size: 1.2em; /* Slightly larger icon */
            vertical-align: middle; /* Align icon vertically with text */
        }

        /* Responsive design */
        @media (max-width: 1024px) { /* Adjust breakpoint for column layout */
            .main-content-inner-wrapper {
                flex-direction: column; /* Stack panels vertically on smaller screens */
                max-width: 700px; /* Adjust overall max-width for stacked panels */
                width: 100%;
                height: auto; /* Allow height to adjust naturally when stacked */
            }

            .quiz-content-panel,
            .quiz-interaction-panel {
                max-height: none; /* Allow natural height when stacked */
                flex: none; /* Remove flex proportions when stacked */
                width: 100%; /* Take full width when stacked */
                min-width: unset; /* Remove min-width constraints */
            }

            /* Adjust options-container max-height when stacked */
            .options-container {
                max-height: 400px; /* Example fixed max-height when stacked, allowing its own scroll */
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 250px; /* Retain original mobile sidebar width */
                position: fixed; /* Make sidebar fixed on smaller screens */
                height: 100%;
                top: 0;
                left: 0;
                z-index: 999;
                padding-top: 0; /* Removed this, sidebar-header handles it */
                transform: translateX(0); /* Default position for fixed sidebar */
            }
            .sidebar.hidden {
                left: -250px; /* Hide completely off-screen */
                width: 0;
                transform: translateX(0); /* Fixed sidebars often use left/right for hiding */
            }
            #showSidebarIconContainer {
                position: fixed; /* Keep fixed for mobile */
                left: 10px; /* Adjust button position */
                top: 10px;
                padding: 10px 15px; /* Larger padding for mobile touch targets */
                font-size: 16px;
            }
            .main-content {
                margin-left: 0; /* No margin on smaller screens */
                padding: 15px; /* Adjust padding for smaller screens */
            }
            body.sidebar-hidden .main-content {
                margin-left: 0; /* When sidebar is hidden, main content still uses full width */
            }
            /* Adjust main content left margin when sidebar is NOT hidden on mobile */
            body:not(.sidebar-hidden) .main-content {
                margin-left: 250px; /* Consistent with mobile sidebar width */
            }
            .quiz-content-panel,
            .quiz-interaction-panel {
                padding: 20px; /* Reduce panel padding */
            }
        }

        @media (max-width: 480px) {
            /* Further adjustments for very small screens */
            .sidebar {
                width: 100%;
                left: 0;
            }
            .sidebar.hidden {
                left: -100%;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .control-button, .timer-display, .score-display {
                width: 100%;
                text-align: center;
            }
            .quiz-content-panel,
            .quiz-interaction-panel {
                padding: 15px; /* Further reduce panel padding */
            }
            .options-container {
                max-height: 300px; /* Further reduce max-height on tiny screens */
            }
        }
    </style>
</head>
<body>
    <!-- 侧边栏隐藏时显示的图标容器，初始隐藏 -->
    <button id="showSidebarIconContainer">
        <i class="fas fa-chevron-circle-right"></i> <!-- 菜单图标 -->
    </button>

    <div class="quiz-container">
        <!-- Sidebar Navigation -->
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h2>测验导航 <i id="hideSidebarIcon" class="fas fa-chevron-circle-left"></i></h2>
                <!-- Custom Type Filter Dropdown -->
                <div class="custom-dropdown" id="custom-quiz-type-filter">
                    <div class="dropdown-toggle" id="quiz-type-toggle">
                        <span id="selected-quiz-type">全部题型</span>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </div>
                    <ul class="dropdown-menu" id="quiz-type-menu">
                        <!-- Options will be populated by JavaScript -->
                    </ul>
                </div>
            </div>
            <div class="sidebar-content">
                <ul id="quiz-nav" class="quiz-nav">
                    <!-- Quiz titles will be inserted here by JavaScript -->
                </ul>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <div class="main-content-inner-wrapper"> <!-- NEW INNER WRAPPER for horizontal layout -->
                <!-- Left Panel: Question Text -->
                <div class="quiz-content-panel">
                    <h2 id="quiz-title"></h2>
                    <div id="quiz-type"></div>
                    <div id="question-text-scroll-wrapper"> <!-- New wrapper for just the scrollable content -->
                        <p id="quiz-content" class="question-content"></p>
                    </div>
                </div>

                <!-- Right Panel: Controls and Options -->
                <div class="quiz-interaction-panel">
                    <div class="controls">
                        <button id="start-quiz-btn" class="control-button">开始作答</button>
                        <div id="timer" class="timer-display">时间: 00:00</div>
                        <div id="score-display" class="score-display">正确率: 0/0 (0%)</div>
                        <button id="submit-quiz-btn" class="control-button">交卷</button>
                    </div>

                    <div id="options-container" class="options-container">
                        <!-- Question blocks and choices will be inserted here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // QuizApp Class to encapsulate all quiz logic and state
        class QuizApp {
            constructor() {
                // DOM Elements
                this.body = document.body;
                this.sidebar = document.getElementById('sidebar');
                this.showSidebarIconContainer = document.getElementById('showSidebarIconContainer');
                this.hideSidebarIcon = document.getElementById('hideSidebarIcon');
                this.quizNav = document.getElementById('quiz-nav');
                
                // Custom Dropdown Elements
                this.customQuizTypeFilter = document.getElementById('custom-quiz-type-filter');
                this.quizTypeToggle = document.getElementById('quiz-type-toggle');
                this.selectedQuizTypeSpan = document.getElementById('selected-quiz-type');
                this.quizTypeMenu = document.getElementById('quiz-type-menu');
                this.dropdownArrow = this.quizTypeToggle.querySelector('.dropdown-arrow');


                this.quizTitleElement = document.getElementById('quiz-title');
                this.quizTypeElement = document.getElementById('quiz-type');
                this.quizContentElement = document.getElementById('quiz-content');
                this.optionsContainer = document.getElementById('options-container');
                this.startQuizBtn = document.getElementById('start-quiz-btn');
                this.submitQuizBtn = document.getElementById('submit-quiz-btn');
                this.timerDisplay = document.getElementById('timer');
                this.scoreDisplay = document.getElementById('score-display');

                // State Variables
                this.currentQuizIndex = 0;
                this.userAnswers = {};
                this.timerInterval = null;
                this.startTime = null;
                this.quizStarted = false;
                this.quizSubmitted = false;
                this.quizScores = {};
                this.selectedQuizType = 'all'; // Keep track of the selected filter type
            }

            /**
             * Initializes the Quiz Application.
             * Sets up event listeners and loads the initial quiz.
             */
            init() {
                // Check if quizData is loaded
                if (typeof quizData === 'undefined') {
                    console.error("Error: quiz_data.js not loaded. Please ensure the file is in the same directory and loaded correctly.");
                    return;
                }

                this.addEventListeners();
                this.populateTypeFilter();
                this.loadQuizNavigation();

                // Set initial sidebar state (assuming open by default)
                this.body.classList.remove('sidebar-hidden');
                this.sidebar.classList.remove('hidden');
                this.showSidebarIconContainer.style.display = 'none';
            }

            /**
             * Adds all necessary event listeners to DOM elements.
             */
            addEventListeners() {
                this.showSidebarIconContainer.addEventListener('click', this.toggleSidebar.bind(this));
                this.hideSidebarIcon.addEventListener('click', this.toggleSidebar.bind(this));

                this.startQuizBtn.addEventListener('click', this.startQuiz.bind(this));
                this.submitQuizBtn.addEventListener('click', this.handleSubmitReattempt.bind(this));
                
                // Event listeners for custom dropdown
                this.quizTypeToggle.addEventListener('click', this.toggleDropdown.bind(this));
                // Close dropdown if clicked outside
                document.addEventListener('click', (event) => {
                    if (!this.customQuizTypeFilter.contains(event.target)) {
                        this.hideDropdown();
                    }
                });
            }

            /**
             * Toggles the visibility of the sidebar.
             */
            toggleSidebar() {
                this.sidebar.classList.toggle('hidden');
                this.body.classList.toggle('sidebar-hidden');
                
                if (this.sidebar.classList.contains('hidden')) {
                    this.showSidebarIconContainer.style.display = 'flex';
                } else {
                    this.showSidebarIconContainer.style.display = 'none';
                }
            }

            /**
             * Toggles the visibility of the custom dropdown menu.
             */
            toggleDropdown() {
                this.quizTypeMenu.classList.toggle('show');
                this.quizTypeToggle.classList.toggle('active');
            }

            /**
             * Hides the custom dropdown menu.
             */
            hideDropdown() {
                this.quizTypeMenu.classList.remove('show');
                this.quizTypeToggle.classList.remove('active');
            }

            /**
             * Populates the custom dropdown menu with unique quiz types.
             */
            populateTypeFilter() {
                const types = new Set();
                quizData.questions.forEach(quiz => {
                    if (quiz.type) {
                        types.add(quiz.type);
                    }
                });

                this.quizTypeMenu.innerHTML = ''; // Clear existing menu items

                // Add "All Types" option
                const allOption = document.createElement('li');
                allOption.textContent = '全部题型';
                allOption.dataset.value = 'all';
                allOption.addEventListener('click', () => this.selectDropdownOption('all', '全部题型'));
                this.quizTypeMenu.appendChild(allOption);

                // Add unique types
                types.forEach(type => {
                    const option = document.createElement('li');
                    option.textContent = type;
                    option.dataset.value = type;
                    option.addEventListener('click', () => this.selectDropdownOption(type, type));
                    this.quizTypeMenu.appendChild(option);
                });
            }

            /**
             * Handles the selection of a custom dropdown option.
             * @param {string} value - The data value of the selected option.
             * @param {string} text - The display text of the selected option.
             */
            selectDropdownOption(value, text) {
                this.selectedQuizTypeSpan.textContent = text;
                this.selectedQuizType = value; // Update the state variable
                this.hideDropdown();
                this.filterQuizNavigation(); // Apply the filter
            }

            /**
             * Filters the quiz navigation list based on the selected type from the custom dropdown.
             */
            filterQuizNavigation() {
                this.loadQuizNavigation(this.selectedQuizType); // Use the stored selected type
            }

            /**
             * Loads and displays the quiz navigation list, optionally filtered by type.
             * @param {string} filterType - The type to filter by, or 'all' for no filter.
             */
            loadQuizNavigation(filterType = 'all') {
                this.quizNav.innerHTML = '';
                const filteredQuizzes = quizData.questions.filter(quiz => {
                    return filterType === 'all' || quiz.type === filterType;
                });

                if (filteredQuizzes.length === 0 && quizData.questions.length > 0) {
                    this.selectedQuizType = 'all'; // Reset filter if no results
                    this.selectedQuizTypeSpan.textContent = '全部题型';
                    this.loadQuizNavigation('all');
                    return;
                }
                if (filteredQuizzes.length === 0) {
                    const noQuizzesItem = document.createElement('li');
                    noQuizzesItem.textContent = '没有可用的测验';
                    noQuizzesItem.style.cursor = 'default';
                    noQuizzesItem.style.opacity = '0.7';
                    this.quizNav.appendChild(noQuizzesItem);
                    this.quizTitleElement.textContent = '';
                    this.quizTypeElement.textContent = '';
                    this.quizContentElement.innerHTML = '';
                    this.optionsContainer.innerHTML = '';
                    this.startQuizBtn.disabled = true;
                    this.submitQuizBtn.disabled = true;
                    this.scoreDisplay.textContent = '正确率: 0/0 (0%)';
                    this.timerDisplay.textContent = '时间: 00:00';
                    return;
                }

                filteredQuizzes.forEach((quiz, index) => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${index + 1}. ${quiz.title}`;
                    listItem.dataset.index = quizData.questions.indexOf(quiz);
                    listItem.title = quiz.title;
                    listItem.addEventListener('click', () => {
                        this.loadQuiz(parseInt(listItem.dataset.index));
                    });
                    this.quizNav.appendChild(listItem);
                });

                let targetQuizIndex = this.currentQuizIndex;
                const currentQuizExistsInFiltered = filteredQuizzes.some(q => quizData.questions.indexOf(q) === targetQuizIndex);

                if (!currentQuizExistsInFiltered && filteredQuizzes.length > 0) {
                    targetQuizIndex = quizData.questions.indexOf(filteredQuizzes[0]);
                } else if (filteredQuizzes.length === 0) {
                     targetQuizIndex = -1;
                }

                if (targetQuizIndex !== -1) {
                    this.loadQuiz(targetQuizIndex);
                } else {
                    this.quizTitleElement.textContent = '';
                    this.quizTypeElement.textContent = '';
                    this.quizContentElement.innerHTML = '';
                    this.optionsContainer.innerHTML = '';
                    this.startQuizBtn.disabled = true;
                    this.submitQuizBtn.disabled = true;
                    this.scoreDisplay.textContent = '正确率: 0/0 (0%)';
                    this.timerDisplay.textContent = '时间: 00:00';
                }
            }

            /**
             * Loads and displays a specific quiz based on its original index in quizData.questions.
             * @param {number} originalIndex - The original index of the quiz in quizData.questions.
             */
            loadQuiz(originalIndex) {
                clearInterval(this.timerInterval);
                this.timerInterval = null;
                this.startTime = null;
                this.quizStarted = false;
                this.quizSubmitted = false;
                this.userAnswers = {};

                this.currentQuizIndex = originalIndex;
                const currentQuiz = quizData.questions[this.currentQuizIndex];

                Array.from(this.quizNav.children).forEach(li => {
                    li.classList.remove('active');
                    if (parseInt(li.dataset.index) === this.currentQuizIndex) {
                        li.classList.add('active');
                    }
                });

                this.quizTitleElement.textContent = currentQuiz.title;
                this.quizTypeElement.textContent = `类型: ${currentQuiz.type}`;
                
                let formattedContent = currentQuiz.content;
                currentQuiz.options.forEach((option, optionIndex) => {
                    const questionNumMatch = option.question.match(/\d+/);
                    if (questionNumMatch) {
                        const questionNum = questionNumMatch[0];
                        const regex = new RegExp(`(?<!<span[^>]*?>)(\\b${questionNum}[\\.\\uff0e)]?)(?!<\\/span>)`, 'g');
                        if (option.question.includes('（') && option.question.includes('）')) {
                            const escapedFullQuestion = this.escapeRegExp(option.question);
                            const fullMatchRegex = new RegExp(`(?<!<span[^>]*?>)(${escapedFullQuestion})(?!<\\/span>)`, 'g');
                            formattedContent = formattedContent.replace(fullMatchRegex, `<span class="question-num-in-text" data-qindex="${optionIndex}">$&</span>`);
                        } else {
                            formattedContent = formattedContent.replace(regex, `<span class="question-num-in-text" data-qindex="${optionIndex}">$&</span>`);
                        }
                    }
                });
                this.quizContentElement.innerHTML = formattedContent;


                this.optionsContainer.innerHTML = '';
                this.scoreDisplay.textContent = '正确率: 0/0 (0%)';
                this.timerDisplay.textContent = '时间: 00:00';

                currentQuiz.options.forEach((option, optionIndex) => {
                    const questionBlockDiv = document.createElement('div');
                    questionBlockDiv.classList.add('question-block');
                    questionBlockDiv.dataset.questionIndex = optionIndex;
                    questionBlockDiv.dataset.correctAnswer = option.answer;

                    const questionSubTitle = document.createElement('div');
                    questionSubTitle.classList.add('question-sub-title');
                    questionSubTitle.textContent = option.question;

                    const choicesWrapper = document.createElement('div');
                    choicesWrapper.classList.add('choices-wrapper');

                    Object.keys(option.choices).forEach(choiceKey => {
                        const choiceItemDiv = document.createElement('div');
                        choiceItemDiv.classList.add('choice-item');
                        choiceItemDiv.dataset.choice = choiceKey;
                        choiceItemDiv.textContent = `${choiceKey}. ${option.choices[choiceKey]}`;
                        choicesWrapper.appendChild(choiceItemDiv);

                        choiceItemDiv.addEventListener('click', () => {
                            if (!this.quizStarted || this.quizSubmitted) return;
                            this.selectOption(optionIndex, choiceKey, questionBlockDiv);
                        });
                    });

                    const questionExplanationDiv = document.createElement('div');
                    questionExplanationDiv.classList.add('question-explanation');
                    questionExplanationDiv.style.display = 'none';

                    questionBlockDiv.appendChild(questionSubTitle);
                    questionBlockDiv.appendChild(choicesWrapper);
                    questionBlockDiv.appendChild(questionExplanationDiv);
                    this.optionsContainer.appendChild(questionBlockDiv);
                });

                this.disableOptions();
                this.startQuizBtn.disabled = false;
                this.submitQuizBtn.disabled = true;
                this.submitQuizBtn.textContent = '交卷';

                if (this.quizScores[currentQuiz.id]) {
                    this.applySubmittedState();
                }
            }

            /**
             * Starts the quiz timer and enables options.
             */
            startQuiz() {
                if (this.quizStarted) return;
                this.quizStarted = true;
                this.startTime = Date.now();
                this.timerInterval = setInterval(this.updateTimer.bind(this), 1000);
                this.startQuizBtn.disabled = true;
                this.submitQuizBtn.disabled = false;
                this.submitQuizBtn.textContent = '交卷';
                this.enableOptions();
                this.scoreDisplay.textContent = '正确率: 未作答';

                if (!this.sidebar.classList.contains('hidden')) {
                    this.sidebar.classList.add('hidden');
                    this.body.classList.add('sidebar-hidden');
                    this.showSidebarIconContainer.style.display = 'flex';
                }
            }

            /**
             * Updates the timer display every second.
             */
            updateTimer() {
                const elapsedTime = Date.now() - this.startTime;
                const minutes = Math.floor(elapsedTime / 60000);
                const seconds = Math.floor((elapsedTime % 60000) / 1000);
                this.timerDisplay.textContent = `时间: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            /**
             * Enables all quiz options for user selection.
             */
            enableOptions() {
                this.optionsContainer.querySelectorAll('.choice-item').forEach(choiceItem => {
                    choiceItem.classList.remove('disabled');
                });
            }

            /**
             * Disables all quiz options and hides explanations.
             */
            disableOptions() {
                this.optionsContainer.querySelectorAll('.choice-item').forEach(choiceItem => {
                    choiceItem.classList.add('disabled');
                    choiceItem.classList.remove('selected-choice', 'correct-choice', 'incorrect-choice');
                });
                this.optionsContainer.querySelectorAll('.question-explanation').forEach(explanationDiv => {
                    explanationDiv.style.display = 'none';
                });
                this.quizContentElement.querySelectorAll('.question-num-in-text').forEach(span => {
                    span.classList.remove('highlighted-question-num');
                });
            }

            /**
             * Handles the selection of an option for a question.
             * @param {number} questionIndex - The index of the question.
             * @param {string} selectedChoice - The key of the selected choice (e.g., 'A', 'B').
             * @param {HTMLElement} questionBlockDiv - The DOM element for the current question block.
             */
            selectOption(questionIndex, selectedChoice, questionBlockDiv) {
                questionBlockDiv.querySelectorAll('.choice-item').forEach(choiceElement => {
                    choiceElement.classList.remove('selected-choice');
                });

                const selectedChoiceElement = questionBlockDiv.querySelector(`.choice-item[data-choice="${selectedChoice}"]`);
                if (selectedChoiceElement) {
                    selectedChoiceElement.classList.add('selected-choice');
                }

                this.userAnswers[questionIndex] = selectedChoice;

                this.quizContentElement.querySelectorAll('.question-num-in-text').forEach(span => {
                    if (parseInt(span.dataset.qindex) === questionIndex) {
                        span.classList.add('highlighted-question-num');
                    } else {
                        span.classList.remove('highlighted-question-num');
                    }
                });
                questionBlockDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            /**
             * Handles quiz submission or re-attempt logic.
             */
            handleSubmitReattempt() {
                const currentQuiz = quizData.questions[this.currentQuizIndex];

                if (!this.quizStarted) {
                    return;
                }

                if (!this.quizSubmitted) {
                    // Logic for Initial Submission
                    clearInterval(this.timerInterval);
                    this.quizSubmitted = true;
                    this.submitQuizBtn.disabled = true;
                    this.startQuizBtn.disabled = true;
                    this.disableOptions();

                    let correctCount = 0;
                    const totalQuestions = currentQuiz.options.length;

                    this.quizContentElement.querySelectorAll('.question-num-in-text').forEach(span => {
                        span.classList.remove('highlighted-question-num');
                    });

                    this.optionsContainer.querySelectorAll('.question-block').forEach(questionBlockDiv => {
                        const questionIndex = parseInt(questionBlockDiv.dataset.questionIndex);
                        const correctAnswer = questionBlockDiv.dataset.correctAnswer;
                        const userAnswer = this.userAnswers[questionIndex];
                        const optionData = currentQuiz.options[questionIndex];
                        const fullExplanation = optionData.explanation;

                        const questionExplanationDiv = questionBlockDiv.querySelector('.question-explanation');
                        questionExplanationDiv.innerHTML = '';
                        let explanationContent = `<div class="explanation-item">`;

                        let isCorrect = false;
                        let userHasAnswered = (userAnswer !== undefined && userAnswer !== null);

                        questionBlockDiv.querySelectorAll('.choice-item').forEach(choiceElement => {
                            const choiceKey = choiceElement.dataset.choice;
                            choiceElement.classList.remove('selected-choice', 'correct-choice', 'incorrect-choice');

                            if (userHasAnswered && String(userAnswer) === String(choiceKey)) {
                                if (String(userAnswer) === String(correctAnswer)) {
                                    choiceElement.classList.add('correct-choice');
                                    isCorrect = true;
                                } else {
                                    choiceElement.classList.add('incorrect-choice');
                                }
                            } else if (String(choiceKey) === String(correctAnswer)) {
                                choiceElement.classList.add('correct-choice');
                            }
                        });

                        if (userHasAnswered) {
                            if (isCorrect) {
                                explanationContent += `你的答案: <span class="your-answer">${userAnswer}. ${optionData.choices[userAnswer]}</span> <i class="fas fa-check-circle explanation-icon" style="color: #28a745;"></i> (正确)<br>`;
                                correctCount++;
                            } else {
                                explanationContent += `你的答案: <span class="your-answer">${userAnswer}. ${optionData.choices[userAnswer]}</span> <i class="fas fa-times-circle explanation-icon" style="color: #dc3545;"></i> (错误)<br>`;
                                explanationContent += `正确答案: <span class="correct-answer">${correctAnswer}. ${optionData.choices[correctAnswer]}</span><br>`;
                            }
                        } else {
                            explanationContent += `你的答案: <span class="your-answer">未作答</span> <i class="fas fa-times-circle explanation-icon" style="color: #dc3545;"></i> (错误)<br>`;
                            explanationContent += `正确答案: <span class="correct-answer">${correctAnswer}. ${optionData.choices[correctAnswer]}</span><br>`;
                        }

                        explanationContent += `<span class="explanation-text">解析: ${fullExplanation}</span></div>`;
                        questionExplanationDiv.innerHTML = explanationContent;
                        questionExplanationDiv.style.display = 'block';
                    });

                    // Calculate and display score
                    const accuracyPercentage = totalQuestions === 0 ? 0 : ((correctCount / totalQuestions) * 100).toFixed(2);
                    this.scoreDisplay.textContent = `正确率: ${correctCount}/${totalQuestions} (${accuracyPercentage}%)`;

                    // Mark quiz as completed in navigation
                    const navItem = this.quizNav.querySelector(`li[data-index="${this.currentQuizIndex}"]`);
                    if (navItem) {
                        navItem.classList.add('completed');
                    }

                    // Store score and user answers for the main quiz ID
                    this.quizScores[currentQuiz.id] = {
                        correct: correctCount,
                        total: totalQuestions,
                        percentage: accuracyPercentage,
                        time: this.timerDisplay.textContent,
                        userAnswers: { ...this.userAnswers }
                    };

                    // After submission, enable submit button and change its text for re-attempt
                    this.submitQuizBtn.disabled = false;
                    this.submitQuizBtn.textContent = '重新作答';

                } else {
                    // Logic for Re-attempt after Submission
                    delete this.quizScores[currentQuiz.id];
                    const navItem = this.quizNav.querySelector(`li[data-index="${this.currentQuizIndex}"]`);
                    if (navItem) {
                        navItem.classList.remove('completed');
                    }
                    this.loadQuiz(this.currentQuizIndex); // Reload the current quiz to reset everything
                }
            }

            /**
             * Applies the visual state for a previously submitted quiz.
             */
            applySubmittedState() {
                this.quizSubmitted = true;
                this.startQuizBtn.disabled = true;
                this.submitQuizBtn.disabled = true;
                this.submitQuizBtn.textContent = '重新作答';
                this.disableOptions();

                const currentQuiz = quizData.questions[this.currentQuizIndex];
                const savedScore = this.quizScores[currentQuiz.id];

                if (savedScore) {
                    this.scoreDisplay.textContent = `正确率: ${savedScore.correct}/${savedScore.total} (${savedScore.percentage}%)`;
                    this.timerDisplay.textContent = savedScore.time;

                    this.quizContentElement.querySelectorAll('.question-num-in-text').forEach(span => {
                        span.classList.remove('highlighted-question-num');
                    });

                    this.optionsContainer.querySelectorAll('.question-block').forEach(questionBlockDiv => {
                        const questionIndex = parseInt(questionBlockDiv.dataset.questionIndex);
                        const correctAnswer = questionBlockDiv.dataset.correctAnswer;
                        const userAnswer = savedScore.userAnswers ? savedScore.userAnswers[questionIndex] : undefined;
                        const optionData = currentQuiz.options[questionIndex];
                        const fullExplanation = optionData.explanation;

                        const questionExplanationDiv = questionBlockDiv.querySelector('.question-explanation');
                        questionExplanationDiv.innerHTML = '';
                        let explanationContent = `<div class="explanation-item">`;

                        let isCorrect = false;
                        let userHasAnswered = (userAnswer !== undefined && userAnswer !== null);

                        questionBlockDiv.querySelectorAll('.choice-item').forEach(choiceElement => {
                            const choiceKey = choiceElement.dataset.choice;
                            choiceElement.classList.remove('selected-choice', 'correct-choice', 'incorrect-choice');

                            if (userHasAnswered && String(userAnswer) === String(choiceKey)) {
                                if (String(userAnswer) === String(correctAnswer)) {
                                    choiceElement.classList.add('correct-choice');
                                    isCorrect = true;
                                } else {
                                    choiceElement.classList.add('incorrect-choice');
                                }
                            } else if (String(choiceKey) === String(correctAnswer)) {
                                choiceElement.classList.add('correct-choice');
                            }
                        });

                        if (userHasAnswered) {
                            if (isCorrect) {
                                explanationContent += `你的答案: <span class="your-answer">${userAnswer}. ${optionData.choices[userAnswer]}</span> <i class="fas fa-check-circle explanation-icon" style="color: #28a745;"></i> (正确)<br>`;
                            } else {
                                explanationContent += `你的答案: <span class="your-answer">${userAnswer}. ${optionData.choices[userAnswer]}</span> <i class="fas fa-times-circle explanation-icon" style="color: #dc3545;"></i> (错误)<br>`;
                                explanationContent += `正确答案: <span class="correct-answer">${correctAnswer}. ${optionData.choices[correctAnswer]}</span><br>`;
                            }
                        } else {
                            explanationContent += `你的答案: <span class="your-answer">未作答</span> <i class="fas fa-times-circle explanation-icon" style="color: #dc3545;"></i> (错误)<br>`;
                            explanationContent += `正确答案: <span class="correct-answer">${correctAnswer}. ${optionData.choices[correctAnswer]}</span><br>`;
                        }

                        explanationContent += `<span class="explanation-text">解析: ${fullExplanation}</span></div>`;
                        questionExplanationDiv.innerHTML = explanationContent;
                        questionExplanationDiv.style.display = 'block';
                    });
                    this.submitQuizBtn.disabled = false;
                }
            }

            /**
             * Helper function to escape special characters in a string for use in a RegExp.
             * @param {string} string - The string to escape.
             * @returns {string} The escaped string.
             */
            escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
        }

        // Initialize the QuizApp when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            const app = new QuizApp();
            app.init();
        });
    </script>
</body>
</html>
